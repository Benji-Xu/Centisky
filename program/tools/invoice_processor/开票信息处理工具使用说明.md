# 开票信息处理工具使用说明

## 功能概览

本工具用于处理各平台（当前主要为**唯品会**和**小米有品**）的开票 Excel 和发票文件，帮助你：

- 生成财务导入所需的开票模板表格；
- 根据平台导出的“待开票/未开具”清单，自动整理订单信息；
- 从唯品会发票 XML 文件夹中整理开票结果，按姓名+金额自动匹配订单号，生成对账表。

## 界面结构

- 顶部：
  - `< 返回首页`：返回 Workit 启动器。
  - `?`：打开本使用说明（本文件）。
  - 主题切换按钮：切换深色/浅色模式。

- 主体区域包含两张卡片：
  1. **选择 Excel 文件**
  2. **处理选项**

---

## 一、选择 Excel 文件

在“选择 Excel 文件”卡片中：

1. 点击 `选择 Excel 文件`：
   - 选择平台导出的原始 Excel 文件：
     - 唯品会：包含 `订单号、发票抬头、发票金额、发票状态` 等列的清单；
     - 小米有品：包含 `订单号、开票状态、金额(包含运费)(元)、商品数量、开票类型、发票抬头` 等列的清单。
2. 文件状态行会显示：`✓ xxx.xlsx` 表示已选择文件。
3. 如需重新选择或清空，点击 `清除`。

> 说明：后续所有“处理发票/整理文件夹”操作，都会基于当前选中的这个 Excel 文件。

---

## 二、处理选项

在“处理选项”卡片中，分为两行：

### 1. 唯品会行

- 左侧标签：`唯品会：`
- 右侧按钮：

#### 1.1 `处理发票`

- 适用对象：唯品会“未开具发票”清单（表1）。
- 功能：
  - 过滤 `发票状态 == 未开具` 的行；
  - 按预设规则生成开票导入模板（类似你现在手工整理的表2）：
    - 自动判定发票类型：个人 / 普票 / 冲红；
    - 固定商品名称为 `无人机`，单位为 `台`；
    - 自动计算数量和单价（含税）；
    - 使用电脑当前日期作为 `开票日期`。
- 输出：
  - 在原 Excel 同目录生成：`原文件名_唯品会开票.xlsx`
  - Sheet1：整理好的导入模板
  - Sheet2：`原始数据`，拷贝原表头和数据

#### 1.2 `整理发票文件夹`

- 适用对象：唯品会开票后提供的**发票 XML+PDF 文件夹**。
- 流程：
  1) 先在“选择 Excel 文件”中选择唯品会表1（包含订单号/抬头/金额）；
  2) 点击 `整理发票文件夹`，选择唯品会的发票文件夹；
  3) 工具会：
     - 扫描该文件夹下所有 `.xml` 发票文件；
     - 从 XML 中读取：
       - 发票抬头（买方名称，自动去掉“（个人）”）
       - 含税金额
       - 发票号码、发票代码（用卖家税号）
       - 开票内容（商品类别 + 明细）
       - 发票创建方式（网页开票/补开/重开等，缺失时默认为“正常”）
     - 使用 **姓名（去括号）+ 金额** 在表1中匹配订单号：
       - 唯一匹配 → 自动填入订单号；
       - 无匹配 → 订单号留空，备注显示“未找到匹配订单号”；
       - 多个匹配 → 订单号留空，备注列中列出候选订单号列表。
- 输出：
  - 在该发票文件夹中生成：`唯品会发票汇总_YYYYMMDD.xlsx`
  - Sheet1：汇总表，字段包括：
    - 订单号、发票类型、发票抬头、发票号码、发票代码、xml链接(留空)、发票下载链接(留空)、
      开票内容类型、开票内容明细、是否红冲发票、配送公司、发票运单号、原发票号码、原发票代码、金额、发票创建方式、备注
  - Sheet2：`表1_原始`，保存你选择的表1原始内容；
  - Sheet3：`文件列表`，列出所有解析到的 XML 文件名及路径。

> 提示：该功能主要用于**对账和上传唯品会发票**时，快速查看“某订单对应哪张发票”。

---

### 2. 小米有品行

- 左侧标签：`小米有品：`
- 右侧按钮：

#### 2.1 `处理发票`

- 适用对象：小米有品导出的“开票列表”Excel（包含 `订单号、开票状态、金额(包含运费)(元)、商品数量、开票类型、发票抬头、纳税人识别号` 等列）。
- 功能：
  - 过滤 `开票状态 == 待开票` 的行；
  - 将每一行转换成你的目标开票导入表结构（类似表4）：
    - 发票类型：
      - `个人电子发票` → `个人发票`
      - `企业电子发票` → `电子普通发票`
    - 开票日期：使用电脑当前日期（`YYYY/M/D` 格式，例如 `2025/11/24`）；
    - 客户名称/税号/地址/电话/开户行/账号：来自表3对应列；
    - 商品名称：固定为 `无人机`；
    - 数量、金额、单价：来自 `商品数量`、`金额(包含运费)(元)` 并自动计算单价；
    - 税率列留空，金额为含税金额。
- 输出：
  - 在原 Excel 同目录生成：`原文件名_小米有品开票.xlsx`
  - Sheet1：整理好的导入模板
  - Sheet2：`原始数据`，拷贝原表头和数据

---

## 常见问题

### Q1. 生成文件时报 `Permission denied`

- 原因：目标文件正在被 Excel 打开或被其它程序占用。
- 处理：
  - 关闭对应的 `_唯品会开票.xlsx` / `_小米有品开票.xlsx` / `唯品会发票汇总_YYYYMMDD.xlsx`；
  - 重新点击处理按钮。
- 工具已做保护：若同名文件存在，会自动生成带 `_2`、`_3` 等后缀的新文件，避免覆盖。

### Q2. 为什么有些行订单号是空的？

- 这些是 **无法通过【姓名+金额】唯一匹配**到表1订单号的记录：
  - 表1中不存在对应的 `发票抬头 + 发票金额`；
  - 或者存在多条同名同金额订单。
- 你可以：
  - 查看汇总表中的 `备注` 列，了解具体原因；
  - 手工在 Excel 中补充订单号。

### Q3. 可以只处理小米有品，或只处理唯品会吗？

- 可以。
- 根据你当前选择的 Excel 文件类型，点击对应平台的一行按钮即可；不需要两个平台都用到。

---

## 建议的文件命名和目录

- 建议将不同平台的原始 Excel 和导出结果放在**各自的子文件夹**中，方便管理：
  - 例：`开票/唯品会/2025-11/1.xlsx` → `1_唯品会开票.xlsx`
  - 例：`开票/小米有品/2025-11/3.xlsx` → `3_小米有品开票.xlsx`
- 唯品会发票 XML 文件夹中生成的汇总表 `唯品会发票汇总_YYYYMMDD.xlsx` 也建议保存在同一文件夹，以便快速比对。

---

如需进一步自定义字段映射或新增其它平台的开票规则，可以在需求里详细说明表头结构和目标格式，再对本工具进行扩展。
