# 螺旋桨匹配功能升级说明

## 概述

本次升级大幅增强了螺旋桨PLD文件的匹配能力，解决了新螺旋桨文件无法自动匹配的问题。

## 主要改进

### 1. 智能自动发现
- **动态扫描**：系统会自动扫描模板目录中所有包含"螺旋桨"关键词的PLD文件
- **多种匹配模式**：支持商品编号直接匹配、店铺前缀匹配、模糊匹配等多种方式
- **向后兼容**：保留原有的静态映射表，确保现有功能不受影响

### 2. 增强的匹配逻辑

#### 匹配优先级（从高到低）：
1. **静态映射表**：优先使用预定义的商品编号映射
2. **动态商品编号匹配**：从PLD文件名中提取商品编号进行匹配
3. **店铺前缀匹配**：根据工作表名称匹配对应店铺的螺旋桨文件
4. **模糊匹配**：查找包含商品编号的螺旋桨文件
5. **通用匹配**：按店铺优先级选择螺旋桨文件

#### 支持的文件命名格式：
- `100181107889螺旋桨.pld` - 商品编号+螺旋桨
- `外星人螺旋桨.pld` - 店铺名+螺旋桨  
- `三只梨螺旋桨.pld` - 店铺名+螺旋桨
- `兽螺旋桨.pld` - 店铺名+螺旋桨
- `901螺旋桨.pld` - 特殊编号+螺旋桨

### 3. 配置文件管理
- **独立配置**：螺旋桨映射配置独立到 `propeller_config.py`
- **易于维护**：可以通过配置文件轻松添加新的映射关系
- **JSON支持**：支持从JSON文件导入/导出映射配置

### 4. 管理工具
提供了 `propeller_manager.py` 管理工具，支持：
- 查看所有现有映射
- 交互式添加新映射
- 移除不需要的映射
- 自动发现未映射的螺旋桨文件

## 使用方法

### 自动使用（推荐）
系统会自动使用新的匹配逻辑，无需额外配置。当配货表E列包含"螺旋桨"时：

1. 系统首先尝试使用A列商品编号在静态映射表中查找
2. 如果没找到，会动态扫描所有螺旋桨PLD文件
3. 根据多种匹配策略自动选择最合适的文件

### 手动管理映射

#### 使用管理工具：
```bash
cd d:\Workit\program\tools\label_box
python propeller_manager.py
```

#### 直接编辑配置文件：
编辑 `propeller_config.py` 中的 `STATIC_PROPELLER_MAP` 字典：

```python
STATIC_PROPELLER_MAP = {
    "100181107889": "外星人螺旋桨.pld",
    "100235985474": "三只梨螺旋桨.pld", 
    "100264779838": "兽螺旋桨.pld",
    "新商品编号": "新螺旋桨文件.pld",  # 添加新映射
}
```

## 新增文件说明

### 1. `propeller_config.py`
- 螺旋桨配置文件
- 包含静态映射表、关键词、店铺前缀等配置
- 提供映射管理函数

### 2. `propeller_manager.py`  
- 螺旋桨映射管理工具
- 提供交互式界面管理映射关系
- 支持自动发现未映射文件

### 3. 增强的核心函数
- `build_dynamic_propeller_map()` - 动态构建映射表
- `find_propeller_template()` - 增强的模板查找函数

## 兼容性说明

- **完全向后兼容**：现有的静态映射表继续有效
- **无缝升级**：不需要修改现有的配货表格式
- **渐进式增强**：可以逐步添加新的映射关系

## 故障排除

### 问题：新螺旋桨文件仍然无法匹配
**解决方案：**
1. 检查PLD文件名是否包含"螺旋桨"关键词
2. 使用管理工具添加明确的映射关系
3. 确保文件名格式符合支持的命名规范

### 问题：匹配到错误的螺旋桨文件
**解决方案：**
1. 在静态映射表中添加明确的商品编号映射
2. 调整PLD文件的命名，使其更具体
3. 使用管理工具查看和调整映射关系

### 问题：配置文件导入失败
**解决方案：**
1. 检查 `propeller_config.py` 文件是否存在语法错误
2. 确保文件编码为UTF-8
3. 系统会自动回退到默认配置，不影响基本功能

## 日志和调试

系统会在处理日志中显示螺旋桨匹配的详细信息：
- 使用的匹配策略
- 找到的候选文件
- 最终选择的文件

查看日志可以帮助诊断匹配问题和优化配置。

## 总结

本次升级显著提升了螺旋桨匹配的智能化程度，从原来的5个固定映射扩展到支持无限数量的动态匹配。系统现在可以：

1. **自动发现**新的螺旋桨PLD文件
2. **智能匹配**基于多种策略
3. **易于维护**通过配置文件和管理工具
4. **完全兼容**现有的工作流程

这些改进将大大减少手动维护映射表的工作量，提高系统的适应性和可扩展性。
